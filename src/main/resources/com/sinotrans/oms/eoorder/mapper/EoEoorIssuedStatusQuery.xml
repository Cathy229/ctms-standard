<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC   
    "-//mybatis.org//DTD Mapper 3.0//EN"  
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinotrans.oms.eoorder.mapper"> 
    <select id="EoEoorIssuedStatusQuery" parameterType="map" resultType="hashmap">  
		<include refid="util.PRE_SQL"></include>
SELECT EOOR.EOOR_ID,
       EOOR.EOOR_STATUS,
       --CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_BOOKING EORB WHERE EORB.EORB_EOOR_ID=EOOR.EOOR_ID AND EORB.EORB_STATUS = 'unissued')>0) THEN 'unissued' ELSE '' END || --未下达
       --CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_BOOKING EORB WHERE EORB.EORB_EOOR_ID=EOOR.EOOR_ID AND EORB.EORB_STATUS = 'issued')>0) THEN 'issued' ELSE '' END || --未反馈      
       --CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_BOOKING EORB WHERE EORB.EORB_EOOR_ID=EOOR.EOOR_ID AND EORB.EORB_STATUS = 'completed')>0) THEN 'completed' ELSE '' END  --已完成
       eorb.EORB_STATUS AS EOOR_EORB_STATUS, --订单订舱状态 
    
       CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_DECLARATION_DEPUTE EODD WHERE EODD.EODD_EOOR_ID=EOOR.EOOR_ID AND EODD.EODD_STATUS = 'unissued')>0) THEN 'unissued' ELSE '' END --未下达
    AS EOOR_EODD_UNISSUED, --订单报关状态  
       CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_DECLARATION_DEPUTE EODD WHERE EODD.EODD_EOOR_ID=EOOR.EOOR_ID AND EODD.EODD_STATUS = 'issued')>0) THEN 'issued' ELSE '' END --未反馈      
    AS EOOR_EODD_ISSUED, --订单报关状态  
       CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_DECLARATION_DEPUTE EODD WHERE EODD.EODD_EOOR_ID=EOOR.EOOR_ID AND EODD.EODD_STATUS = 'completed')>0) THEN 'completed' ELSE '' END  --已完成
    AS EOOR_EODD_SUCCESS, --订单报关状态  
       
      CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_TRAILER EOET WHERE EOET.EOET_EOOR_ID=EOOR.EOOR_ID AND EOET.EOET_STATUS = 'unissued')>0) THEN 'unissued' ELSE '' END --未下达
    AS EOOR_EOET_UNISSUED, --订单拖车状态  
       CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_TRAILER EOET WHERE EOET.EOET_EOOR_ID=EOOR.EOOR_ID AND EOET.EOET_STATUS= 'issued')>0) THEN 'issued' ELSE '' END--未反馈      
    AS EOOR_EOET_ISSUED, --订单拖车状态  
       CASE WHEN ((SELECT COUNT(*) FROM EO_REQUEST_TRAILER EOET WHERE EOET.EOET_EOOR_ID=EOOR.EOOR_ID  AND EOET.EOET_STATUS= 'completed')>0) THEN 'completed' ELSE '' END  --已完成
    AS EOOR_EOET_SUCCESS, --订单拖车状态
     
       CASE WHEN ((SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID)=0) THEN '1' ELSE '' END ||
       CASE WHEN ((SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID)>0 AND (SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID AND  EFBF.EFBF_STATUS IN (0, -3 ,-4, 1, 9, 2 ,-2))>0) THEN '2' ELSE '' END ||
       CASE WHEN ((SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID)>0 AND (SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID AND  EFBF.EFBF_STATUS = 3) = (SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID)) THEN '3' ELSE '' END ||
       CASE WHEN ((SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID)>0 AND (SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID AND  EFBF.EFBF_STATUS = 4)>0 AND (SELECT COUNT(*) FROM EF_BUSINESS_FEES EFBF WHERE EFBF.EFBF_EOOR_ID=EOOR.EOOR_ID AND  EFBF.EFBF_STATUS IN (0, -3 ,-4, 1, 9, 2 ,-2)) = 0) THEN '4' ELSE '' END 
    AS EOOR_FEE_STATUS --订单费用状态 
        
  FROM EO_ORDER EOOR LEFT JOIN EO_REQUEST_BOOKING EORB ON EOOR.EOOR_ID = EORB.EORB_EOOR_ID
 WHERE 1 = 1
 	<if test="sqlCond.eoorId !='' and sqlCond.eoorId !=null">
       AND  EOOR.EOOR_ID=#{sqlCond.eoorId}
   </if>
		<include refid="util.POST_SQL"></include>
	</select>
</mapper>
